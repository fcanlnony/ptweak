#!/usr/bin/env bash
set -euo pipefail

VERSION="0.0.1"

cmd_power_profile_list="power-list"
cmd_power_profile_set="power-set"
cmd_cpu_governor_list="cpufreq-list"
cmd_cpu_governor_set="cpufreq-set"

show_general_help() {
  cat <<'HELP'
Usage:
  ptweak help [command]
  ptweak power-list
  ptweak power-set <performance|power-saver|balanced>
  ptweak cpufreq-list
  ptweak cpufreq-set <powersave|performance>

Commands:
  power-list           Show current power profiles via powerprofilesctl list
  power-set            Set power profile via powerprofilesctl set <mode>
  cpufreq-list         Show CPU governors via cpupower frequency-info --governors
  cpufreq-set          Set CPU governor via cpupower frequency-set -g <mode>
HELP
}

show_command_help() {
  case "$1" in
    "$cmd_power_profile_list")
      echo "Show current power profiles via: powerprofilesctl list"
      ;;
    "$cmd_power_profile_set")
      echo "Set power profile via: powerprofilesctl set <performance|power-saver|balanced>"
      ;;
    "$cmd_cpu_governor_list")
      echo "Show CPU governors via: cpupower frequency-info --governors"
      ;;
    "$cmd_cpu_governor_set")
      echo "Set CPU governor via: cpupower frequency-set -g <powersave|performance>"
      ;;
    *)
      echo "Unknown command: $1" >&2
      exit 1
      ;;
  esac
}

require_arg_count() {
  local expected="$1"
  local actual="$2"
  if [[ "$actual" -ne "$expected" ]]; then
    echo "Invalid arguments. Use 'ptweak help' or 'ptweak help <command>'." >&2
    exit 1
  fi
}

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "Root privileges required. Please run with sudo." >&2
    exit 1
  fi
}

if [[ $# -eq 0 ]]; then
  show_general_help
  exit 0
fi

if [[ "$1" == "--version" ]]; then
  echo "ptweak: version $VERSION"
  exit 0
fi

if [[ "$1" == "help" ]]; then
  if [[ $# -eq 1 ]]; then
    show_general_help
    exit 0
  fi
  if [[ $# -eq 2 ]]; then
    show_command_help "$2"
    exit 0
  fi
  echo "Invalid arguments. Use 'ptweak help' or 'ptweak help <command>'." >&2
  exit 1
fi

command="$1"
shift

case "$command" in
  "$cmd_power_profile_list")
    require_arg_count 0 "$#"
    require_root
    powerprofilesctl list
    ;;
  "$cmd_power_profile_set")
    require_arg_count 1 "$#"
    require_root
    mode="$1"
    case "$mode" in
      performance|power-saver|balanced)
        powerprofilesctl set "$mode"
        ;;
      *)
        echo "Invalid mode for power-profile-set: $mode" >&2
        exit 1
        ;;
    esac
    ;;
  "$cmd_cpu_governor_list")
    require_arg_count 0 "$#"
    require_root
    cpupower frequency-info --governors
    ;;
  "$cmd_cpu_governor_set")
    require_arg_count 1 "$#"
    require_root
    mode="$1"
    case "$mode" in
      powersave|performance)
        cpupower frequency-set -g "$mode"
        ;;
      *)
        echo "Invalid mode for cpu-governor-set: $mode" >&2
        exit 1
        ;;
    esac
    ;;
  *)
    echo "Unknown command: $command" >&2
    exit 1
    ;;
esac
