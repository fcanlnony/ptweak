#!/usr/bin/env bash
set -euo pipefail

VERSION="0.0.2"

cmd_power_profile_list="power-list"
cmd_power_profile_set="power-set"
cmd_cpu_governor_list="cpufreq-list"
cmd_cpu_governor_set="cpufreq-set"
cmd_io_scheduler_list="io-list"
cmd_io_scheduler_set="io-set"

show_general_help() {
  cat <<'HELP'
Usage:
  ptweak help [command]
  ptweak power-list
  ptweak power-set <performance|power-saver|balanced>
  ptweak cpufreq-list
  ptweak cpufreq-set <powersave|performance>
  ptweak io-list <all|current>
  ptweak io-set <all|current> <scheduler>

Commands:
  power-list           Show current power profiles via powerprofilesctl list
  power-set            Set power profile via powerprofilesctl set <mode>
  cpufreq-list         Show CPU governors via cpupower frequency-info --governors
  cpufreq-set          Set CPU governor via cpupower frequency-set -g <mode>
  io-list              Show block I/O schedulers for all or current devices
  io-set               Set block I/O scheduler for all or current devices
HELP
}

show_command_help() {
  case "$1" in
    "$cmd_power_profile_list")
      echo "Show current power profiles via: powerprofilesctl list"
      ;;
    "$cmd_power_profile_set")
      echo "Set power profile via: powerprofilesctl set <performance|power-saver|balanced>"
      ;;
    "$cmd_cpu_governor_list")
      echo "Show CPU governors via: cpupower frequency-info --governors"
      ;;
    "$cmd_cpu_governor_set")
      echo "Set CPU governor via: cpupower frequency-set -g <powersave|performance>"
      ;;
    "$cmd_io_scheduler_list")
      echo "Show block I/O schedulers via: io-list <all|current>"
      ;;
    "$cmd_io_scheduler_set")
      echo "Set block I/O scheduler via: io-set <all|current> <scheduler>"
      ;;
    *)
      echo "Unknown command: $1" >&2
      exit 1
      ;;
  esac
}

require_arg_count() {
  local expected="$1"
  local actual="$2"
  if [[ "$actual" -ne "$expected" ]]; then
    echo "Invalid arguments. Use 'ptweak help' or 'ptweak help <command>'." >&2
    exit 1
  fi
}

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "Root privileges required. Please run with sudo." >&2
    exit 1
  fi
}

is_supported_scheduler() {
  local scheduler="$1"
  local scheduler_file="$2"
  local contents
  contents="$(cat "$scheduler_file")"
  contents="${contents//[/}"
  contents="${contents//]/}"
  for item in $contents; do
    if [[ "$item" == "$scheduler" ]]; then
      return 0
    fi
  done
  return 1
}

list_io_all_paths() {
  local path
  for path in /sys/block/*/queue/scheduler; do
    local dev="${path#/sys/block/}"
    dev="${dev%%/*}"
    if [[ "$dev" =~ ^sd[a-z]+$ || "$dev" =~ ^mmcblk[0-9]+$ || "$dev" =~ ^nvme[0-9].*$ ]]; then
      echo "$path"
    fi
  done
}

list_io_current_paths() {
  local name
  while IFS= read -r name; do
    if [[ -n "$name" ]]; then
      echo "/sys/block/$name/queue/scheduler"
    fi
  done < <(lsblk -dno NAME)
}

if [[ $# -eq 0 ]]; then
  show_general_help
  exit 0
fi

if [[ "$1" == "--version" ]]; then
  echo "ptweak: version $VERSION"
  exit 0
fi

if [[ "$1" == "help" ]]; then
  if [[ $# -eq 1 ]]; then
    show_general_help
    exit 0
  fi
  if [[ $# -eq 2 ]]; then
    show_command_help "$2"
    exit 0
  fi
  echo "Invalid arguments. Use 'ptweak help' or 'ptweak help <command>'." >&2
  exit 1
fi

command="$1"
shift

case "$command" in
  "$cmd_power_profile_list")
    require_arg_count 0 "$#"
    require_root
    powerprofilesctl list
    ;;
  "$cmd_power_profile_set")
    require_arg_count 1 "$#"
    require_root
    mode="$1"
    case "$mode" in
      performance|power-saver|balanced)
        powerprofilesctl set "$mode"
        ;;
      *)
        echo "Invalid mode for power-profile-set: $mode" >&2
        exit 1
        ;;
    esac
    ;;
  "$cmd_cpu_governor_list")
    require_arg_count 0 "$#"
    require_root
    cpupower frequency-info --governors
    ;;
  "$cmd_cpu_governor_set")
    require_arg_count 1 "$#"
    require_root
    mode="$1"
    case "$mode" in
      powersave|performance)
        cpupower frequency-set -g "$mode"
        ;;
      *)
        echo "Invalid mode for cpu-governor-set: $mode" >&2
        exit 1
        ;;
    esac
    ;;
  "$cmd_io_scheduler_list")
    require_arg_count 1 "$#"
    require_root
    scope="$1"
    case "$scope" in
      current)
        mapfile -t targets < <(list_io_current_paths)
        if [[ "${#targets[@]}" -eq 0 ]]; then
          echo "No block devices found for io-list: current" >&2
          exit 1
        fi
        cat "${targets[@]}"
        ;;
      all)
        grep "" /sys/block/*/queue/scheduler | grep -E '/sys/block/(sd[a-z]+|mmcblk[0-9]+|nvme[0-9][^/]*)/queue/scheduler'
        ;;
      *)
        echo "Invalid scope for io-list: $scope (use all|current)" >&2
        exit 1
        ;;
    esac
    ;;
  "$cmd_io_scheduler_set")
    require_arg_count 2 "$#"
    require_root
    scope="$1"
    scheduler="$2"
    case "$scope" in
      current)
        mapfile -t targets < <(list_io_current_paths)
        ;;
      all)
        mapfile -t targets < <(list_io_all_paths)
        ;;
      *)
        echo "Invalid scope for io-set: $scope (use all|current)" >&2
        exit 1
        ;;
    esac

    if [[ "${#targets[@]}" -eq 0 ]]; then
      echo "No matching block devices found for io-set: $scope" >&2
      exit 1
    fi

    for path in "${targets[@]}"; do
      if [[ ! -e "$path" ]]; then
        echo "Missing scheduler path: $path" >&2
        exit 1
      fi
      if ! is_supported_scheduler "$scheduler" "$path"; then
        dev="${path#/sys/block/}"
        dev="${dev%%/*}"
        echo "Scheduler not supported on $dev: $scheduler" >&2
        exit 1
      fi
    done

    for path in "${targets[@]}"; do
      echo "$scheduler" > "$path"
    done
    ;;
  *)
    echo "Unknown command: $command" >&2
    exit 1
    ;;
esac
